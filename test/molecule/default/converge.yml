- hosts: all
  become: yes
  tasks:
    - name: install dependencies
      vars:
        libvirt_guest_service:
          - python3-dbus
          - python3-libvirt
        libvirtd:
          - qemu-system-x86
          - qemu-utils  # qemu-img
          - libvirt-clients
          - libvirt-daemon-system
      package:
        state: present
        name: '{{ libvirtd + libvirt_guest_service}}'

    - name: create directory for virtual machine images
      file:
        state: directory
        path: /vm

    - name: download virtual machine base image
      get_url:
        url: https://dl-cdn.alpinelinux.org/alpine/v3.15/releases/x86/alpine-virt-3.15.0-x86.iso
        checksum: sha256:ad0c6f95754c29b31c6afd29a9acefa121a127c80f225a90a9495e6b5bc74b48
        dest: /vm/base.qcow2
        owner: libvirt-qemu
        mode: '0600'
      register: get_url
      until: get_url is not failed
      retries: 10
      delay: 2

    - name: derive guest images from the base one
      loop: '{{ guests }}'
      command: 'qemu-img create -f qcow2 -b /vm/base.qcow2 /vm/{{ item }}.qcow2'
      args:
        creates: '/vm/{{ item }}.qcow2'

    - name: check list of virtual machine definitions
      virt:
        command: list_vms
      register: libvirt

    - name: define virtual machine
      loop: '{{ guests }}'
      virt:
        command: define
        xml: '{{ lookup("template", "libvirt.xml") }}'
      when: item not in libvirt.list_vms
