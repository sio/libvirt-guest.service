- hosts: all
  become: yes
  tasks:
    - name: install dependencies
      vars:
        libvirt_guest_service:
          - python3-dbus
          - python3-libvirt
        libvirtd:
          - qemu-system-x86
          - qemu-utils  # qemu-img
          - libvirt-clients
          - libvirt-daemon-system
      package:
        state: present
        name: '{{ libvirtd + libvirt_guest_service}}'

    - name: create directory for virtual machine images
      file:
        state: directory
        path: /vm

    - name: download virtual machine base image
      get_url:
        # Cirros is a Linux distro made specifically for test purposes
        # Features:
        #   - small image size
        #   - insecure default login with known password
        #   - console=ttyS0 in kernel cmdline (used by virsh login)
        #   - acpid is started automatically on boot (unlike Alpine Live ISO
        #     which can not handle power button events until acpid is started manually)
        url: https://download.cirros-cloud.net/0.5.2/cirros-0.5.2-x86_64-disk.img
        checksum: md5:https://download.cirros-cloud.net/0.5.2/MD5SUMS
        dest: /vm/base.qcow2
        owner: libvirt-qemu
        mode: '0600'
      register: get_url
      until: get_url is not failed
      retries: 10
      delay: 2

    - name: derive guest images from the base one
      loop: '{{ guests }}'
      command: 'qemu-img create -f qcow2 -b /vm/base.qcow2 /vm/{{ item }}.qcow2'
      args:
        creates: '/vm/{{ item }}.qcow2'

    - name: check list of virtual machine definitions
      virt:
        command: list_vms
      register: libvirt

    - name: define virtual machine
      loop: '{{ guests }}'
      virt:
        command: define
        xml: '{{ lookup("template", "libvirt.xml") }}'
      when: item not in libvirt.list_vms
